{% extends "base.html" %}
{% load static %}

{% block title %}‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡πâ‡∏≤{% endblock %}

{% block content %}
<div class="bg-blue-100 p-6">
    <div class="max-w-lg mx-auto bg-white p-6 rounded shadow">
        <h1 class="text-xl font-bold mb-4 text-center">üìÑ ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡πâ‡∏≤</h1>

        <form id="uploadForm" method="POST" enctype="multipart/form-data" action="{% url 'skin_data_upload' %}" onsubmit="return validateUpload()">
            {% csrf_token %}

            <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏¥‡∏ß -->
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏¥‡∏ß:</label>
                <select id="skin_type" name="skin_type" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="normal">‡∏ú‡∏¥‡∏ß‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
                    <option value="oily">‡∏ú‡∏¥‡∏ß‡∏°‡∏±‡∏ô</option>
                    <option value="dry">‡∏ú‡∏¥‡∏ß‡πÅ‡∏´‡πâ‡∏á</option>
                    <option value="combination">‡∏ú‡∏¥‡∏ß‡∏ú‡∏™‡∏°</option>
                    <option value="sensitive">‡∏ú‡∏¥‡∏ß‡πÅ‡∏û‡πâ‡∏á‡πà‡∏≤‡∏¢</option>
                </select>
            </div>

            <!-- ‚úÖ ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ú‡∏¥‡∏ß -->
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</label>
                <textarea name="concern" rows="4" class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
            </div>

            <!-- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ -->
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô:</label>
                <textarea name="allergy_history" rows="4" class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
            </div>

            <!-- ‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ -->
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</label>
                <textarea name="current_products" rows="4" class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
            </div>

            <!-- ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ -->
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡πâ‡∏≤:</label>
                <textarea name="skincare_goal" rows="4" class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
            </div>


            <!-- ‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û -->
            <div class="mb-4">
                <label class="block text-gray-700 font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏£‡∏π‡∏õ):</label>
                <input type="file" id="fileInput" name="images" accept="image/*" multiple class="block w-full border rounded p-2">
                <p id="file-error" class="text-red-500 text-sm hidden">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏£‡∏π‡∏õ</p>
                <div id="uploadedPreview" class="flex flex-wrap mt-2"></div>
            </div>

            <!-- ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á -->
            <div class="mb-4 text-center">
                <button type="button" id="openCamera" class="bg-blue-500 text-white px-4 py-2 rounded">
                    üì∏ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                </button>
                <button type="button" id="closeCamera" class="bg-gray-500 text-white px-4 py-2 rounded hidden">
                    ‚ùå ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                </button>
            </div>

            <div id="cameraContainer" class="mb-4 hidden">
                <video id="video" autoplay class="border rounded mb-2 w-full"></video>
                <canvas id="canvas" class="hidden"></canvas>
                <button type="button" id="capture" class="bg-green-500 text-white px-4 py-2 rounded w-full">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
                <div id="capturedPreview" class="flex flex-wrap mt-2"></div>
            </div>

            <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á -->
            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded w-full">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
        </form>
    </div>
</div>

<script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const captureButton = document.getElementById("capture");
    const fileInput = document.getElementById("fileInput");
    const uploadedPreview = document.getElementById("uploadedPreview");
    const capturedPreview = document.getElementById("capturedPreview");
    const fileError = document.getElementById("file-error");
    const cameraContainer = document.getElementById("cameraContainer");
    const openCamera = document.getElementById("openCamera");
    const closeCamera = document.getElementById("closeCamera");

    let selectedFiles = [];
    let cameraStream = null;

    openCamera.addEventListener("click", () => {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                cameraStream = stream;
                video.srcObject = stream;
                cameraContainer.classList.remove("hidden");
                openCamera.classList.add("hidden");
                closeCamera.classList.remove("hidden");
            })
            .catch(err => {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á");
            });
    });

    closeCamera.addEventListener("click", () => {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        cameraContainer.classList.add("hidden");
        openCamera.classList.remove("hidden");
        closeCamera.classList.add("hidden");
    });

    captureButton.addEventListener("click", () => {
        const context = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(blob => {
            const imageFile = new File([blob], `capture-${Date.now()}.png`, { type: "image/png" });
            selectedFiles.push(imageFile);
            const imgElement = document.createElement("img");
            imgElement.src = URL.createObjectURL(blob);
            capturedPreview.appendChild(imgElement);
        }, "image/png");
    });
</script>

{% endblock %}
